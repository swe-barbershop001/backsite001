name: ðŸš€ CI/CD Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

env:
  NODE_VERSION: '20'
  DOCKER_IMAGE_NAME: barbershop-bot
  APP_DIR: /home/ubuntu/barbershop-bot

jobs:
  # ============================================
  # Job 1: Setup - Checkout and Verify
  # ============================================
  setup:
    name: ðŸ“‹ Setup & Verify
    runs-on: ubuntu-latest
    outputs:
      branch: ${{ steps.branch.outputs.name }}
      sha: ${{ steps.sha.outputs.short }}
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ” Get branch name
        id: branch
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "name=${{ github.head_ref }}" >> $GITHUB_OUTPUT
          else
            echo "name=${GITHUB_REF#refs/heads/}" >> $GITHUB_OUTPUT
          fi

      - name: ðŸ” Get short SHA
        id: sha
        run: echo "short=$(echo ${{ github.sha }} | cut -c1-7)" >> $GITHUB_OUTPUT

      - name: âœ… Verify branch
        run: |
          BRANCH="${{ steps.branch.outputs.name }}"
          echo "Current branch: $BRANCH"
          if [ "${{ github.event_name }}" = "push" ] && [ "$BRANCH" != "main" ]; then
            echo "âš ï¸ Warning: Not on main branch, but continuing..."
          fi
          echo "âœ… Branch verification passed"

      - name: ðŸ“Š Workflow info
        run: |
          echo "ðŸ”¹ Repository: ${{ github.repository }}"
          echo "ðŸ”¹ Branch: ${{ steps.branch.outputs.name }}"
          echo "ðŸ”¹ Commit SHA: ${{ steps.sha.outputs.short }}"
          echo "ðŸ”¹ Event: ${{ github.event_name }}"

  # ============================================
  # Job 2: Build - Install, Build, Save Image
  # ============================================
  build:
    name: ðŸ—ï¸ Build Docker Image
    runs-on: ubuntu-latest
    needs: setup
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
      image-digest: ${{ steps.meta.outputs.digest }}
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ—ï¸ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ“¦ Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¥ Install dependencies
        run: |
          echo "ðŸ“¦ Installing dependencies..."
          npm ci
          echo "âœ… Dependencies installed successfully"

      - name: ðŸ” Run linter
        run: |
          echo "ðŸ” Running ESLint..."
          npm run lint || echo "âš ï¸ Lint warnings found (non-blocking)"

      - name: ðŸ—ï¸ Build application
        run: |
          echo "ðŸ—ï¸ Building application..."
          npm run build
          echo "âœ… Application built successfully"

      - name: ðŸ³ Extract metadata
        id: meta
        run: |
          IMAGE_TAG="${{ env.DOCKER_IMAGE_NAME }}:${{ needs.setup.outputs.sha }}"
          IMAGE_LATEST="${{ env.DOCKER_IMAGE_NAME }}:latest"
          echo "tags=$IMAGE_TAG,$IMAGE_LATEST" >> $GITHUB_OUTPUT
          echo "ðŸ”¹ Image tags: $IMAGE_TAG, $IMAGE_LATEST"

      - name: ðŸ³ Build Docker image
        run: |
          IMAGE_TAG="${{ env.DOCKER_IMAGE_NAME }}:${{ needs.setup.outputs.sha }}"
          IMAGE_LATEST="${{ env.DOCKER_IMAGE_NAME }}:latest"
          
          echo "ðŸ³ Building Docker image: $IMAGE_TAG"
          docker build -t $IMAGE_TAG -t $IMAGE_LATEST .
          
          echo "âœ… Docker image built successfully"
          docker images | grep "${{ env.DOCKER_IMAGE_NAME }}"

      - name: ðŸ’¾ Save Docker image
        run: |
          IMAGE_TAG="${{ env.DOCKER_IMAGE_NAME }}:${{ needs.setup.outputs.sha }}"
          IMAGE_FILE="docker-image-${{ needs.setup.outputs.sha }}.tar"
          
          echo "ðŸ’¾ Saving Docker image to $IMAGE_FILE..."
          docker save $IMAGE_TAG -o $IMAGE_FILE
          
          # Compress the image to reduce size
          echo "ðŸ—œï¸ Compressing image..."
          gzip -f $IMAGE_FILE
          
          echo "âœ… Image saved and compressed: ${IMAGE_FILE}.gz"
          ls -lh ${IMAGE_FILE}.gz

      - name: ðŸ“¤ Upload Docker image artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-image-${{ needs.setup.outputs.sha }}
          path: docker-image-${{ needs.setup.outputs.sha }}.tar.gz
          retention-days: 1
          compression-level: 0

      - name: ðŸ“Š Build summary
        run: |
          echo "### ðŸ—ï¸ Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Image Name:** ${{ env.DOCKER_IMAGE_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Image Tag:** ${{ needs.setup.outputs.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** âœ… Success" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # Job 3: Deploy - SSH to EC2 and Deploy
  # ============================================
  deploy:
    name: ðŸš€ Deploy to EC2
    runs-on: ubuntu-latest
    needs: [setup, build]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    environment:
      name: production
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ“¥ Download Docker image artifact
        uses: actions/download-artifact@v4
        with:
          name: docker-image-${{ needs.setup.outputs.sha }}
          path: ./

      - name: ðŸš€ Create target directory on server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_PORT || 22 }}
          timeout: 30s
          command_timeout: 30s
          script: |
            mkdir -p ${{ env.APP_DIR }}
            cd ${{ env.APP_DIR }}
            echo "âœ… Directory created: ${{ env.APP_DIR }}"

      - name: ðŸ“¤ Copy files to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_PORT || 22 }}
          source: "docker-image-${{ needs.setup.outputs.sha }}.tar.gz,docker-compose.yml"
          target: ${{ env.APP_DIR }}
          timeout: 30s
          command_timeout: 10m
          debug: true
          strip_components: 0
          overwrite: true

      - name: ðŸ³ Deploy Docker containers
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_PORT || 22 }}
          timeout: 30s
          command_timeout: 10m
          script: |
            cd ${{ env.APP_DIR }}
            
            # Verify files
            echo "ðŸ“‹ Verifying files..."
            ls -l || echo "Directory listing failed"
            ls -l docker-compose.yml || echo "docker-compose.yml not found"
            ls -l docker-image-*.tar.gz || echo "Docker image file not found"
            
            # Determine docker command (with or without sudo)
            if groups | grep -q docker; then
              DOCKER_CMD="docker"
              COMPOSE_CMD="docker-compose"
            else
              DOCKER_CMD="sudo docker"
              COMPOSE_CMD="sudo docker-compose"
            fi
            
            # Stop old containers
            echo "ðŸ›‘ Stopping old containers..."
            $COMPOSE_CMD down || echo "docker-compose down failed"
            
            # Load Docker image
            IMAGE_FILE=$(ls docker-image-*.tar.gz | head -1)
            IMAGE_TAG="${{ env.DOCKER_IMAGE_NAME }}:${{ needs.setup.outputs.sha }}"
            
            echo "ðŸ“¥ Loading Docker image: $IMAGE_FILE"
            gunzip -c $IMAGE_FILE | $DOCKER_CMD load
            $DOCKER_CMD tag $IMAGE_TAG ${{ env.DOCKER_IMAGE_NAME }}:latest
            echo "âœ… Docker image loaded successfully"
            
            # Create .env file
            echo "ðŸ“ Creating .env file..."
            echo "BOT_TOKEN=${{ secrets.BOT_TOKEN }}" > .env
            echo "SUPER_ADMIN_USERNAME=${{ vars.SUPER_ADMIN_USERNAME }}" >> .env
            echo "SUPER_ADMIN_PASSWORD=${{ secrets.SUPER_ADMIN_PASSWORD }}" >> .env
            echo "SUPER_ADMIN_NAME=${{ vars.SUPER_ADMIN_NAME }}" >> .env
            echo "SUPER_ADMIN_PHONE=${{ vars.SUPER_ADMIN_PHONE }}" >> .env
            echo "JWT_TOKEN_SECRET=${{ secrets.JWT_TOKEN_SECRET }}" >> .env
            echo "JWT_TOKEN_EXPIRATION=${{ vars.JWT_TOKEN_EXPIRATION }}" >> .env
            echo "DB_HOST=db" >> .env
            echo "DB_PORT=${{ vars.DB_PORT }}" >> .env
            echo "DB_USERNAME=${{ vars.DB_USERNAME }}" >> .env
            echo "DB_PASSWORD=${{ secrets.DB_PASSWORD }}" >> .env
            echo "DB_DATABASE=${{ vars.DB_DATABASE }}" >> .env
            echo "PORT=${{ vars.PORT }}" >> .env
            echo "NODE_ENV=production" >> .env
            
            # Fix line endings (Windows compatibility)
            sudo apt-get update && sudo apt-get install -y dos2unix || echo "dos2unix installation failed"
            dos2unix .env || echo "dos2unix conversion failed"
            
            cat .env
            
            # Update docker-compose.yml to use image instead of build
            echo "ðŸ”§ Updating docker-compose.yml..."
            IMAGE_NAME="${{ env.DOCKER_IMAGE_NAME }}:latest"
            awk -v img="$IMAGE_NAME" '
            /^  app:/ { in_app=1; print; next }
            in_app && /^    build:/ { 
              print "    image: " img
              skip_build=1
              next
            }
            skip_build && /^      (context|dockerfile):/ { next }
            skip_build && /^    [a-z]/ { skip_build=0; in_app=0 }
            { print }
            ' docker-compose.yml > docker-compose.yml.tmp && mv docker-compose.yml.tmp docker-compose.yml
            
            # Verify docker-compose config
            echo "ðŸ” Verifying docker-compose configuration..."
            $COMPOSE_CMD config || echo "docker-compose config failed"
            
            # Clean up old images
            echo "ðŸ§¹ Cleaning up old images..."
            $DOCKER_CMD system prune -f --volumes || echo "Docker prune failed"
            
            # Build and start containers
            echo "ðŸš€ Building and starting containers..."
            $COMPOSE_CMD build || echo "docker-compose build failed"
            $COMPOSE_CMD up -d
            
            # Wait a bit for containers to start
            sleep 10
            
            # Show container status
            echo "ðŸ“Š Container status:"
            $DOCKER_CMD ps -a
            
            # Show logs
            echo "ðŸ“‹ Application logs:"
            $DOCKER_CMD logs $($DOCKER_CMD ps -q --filter "name=barbershop-bot") || echo "No app container logs"
            
            echo "ðŸ“‹ Database logs:"
            $DOCKER_CMD logs $($DOCKER_CMD ps -q --filter "name=barbershop-db") || echo "No db container logs"
            
            echo "âœ… Deployment completed successfully!"

      - name: ðŸ“Š Deployment summary
        run: |
          echo "### ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Server:** ${{ secrets.DEPLOY_HOST }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Image:** ${{ env.DOCKER_IMAGE_NAME }}:${{ needs.setup.outputs.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** âœ… Success" >> $GITHUB_STEP_SUMMARY
          echo "- **URL:** http://${{ secrets.DEPLOY_HOST }}:${{ vars.PORT }}" >> $GITHUB_STEP_SUMMARY
